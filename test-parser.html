<!DOCTYPE html>
<html>
<head>
    <title>Test Shopify Parser</title>
</head>
<body>
    <h1>Testing Shopify Parser</h1>
    <div id="results"></div>
    <script>
        // Mock Shopify API response
        const mockShopifyResponse = {
            "products": [
                {
                    "id": 123,
                    "title": "Navigator GMT 40mm Steel",
                    "handle": "navigator-gmt-40mm",
                    "created_at": "2025-01-15T10:00:00-05:00",
                    "variants": [
                        {
                            "price": "425.00",
                            "option1": "40mm",
                            "available": true
                        }
                    ],
                    "tags": ["steel", "automatic", "40mm"]
                },
                {
                    "id": 124,
                    "title": "Explorer II Automatic",
                    "handle": "explorer-ii",
                    "created_at": "2025-01-16T10:00:00-05:00",
                    "variants": [
                        {
                            "price": "395.00",
                            "option1": "42mm",
                            "available": true
                        }
                    ],
                    "tags": ["42mm", "automatic"]
                },
                {
                    "id": 125,
                    "title": "Submariner Heritage 40mm",
                    "handle": "submariner",
                    "created_at": "2025-01-17T10:00:00-05:00",
                    "variants": [
                        {
                            "price": "485.00",
                            "option1": "Standard",
                            "available": true
                        }
                    ],
                    "tags": ["diver", "automatic"]
                },
                {
                    "id": 126,
                    "title": "",
                    "handle": "invalid",
                    "created_at": "2025-01-18T10:00:00-05:00",
                    "variants": [
                        {
                            "price": "100.00",
                            "option1": "40mm"
                        }
                    ]
                },
                {
                    "id": 127,
                    "title": "Invalid Price Watch",
                    "handle": "invalid-price",
                    "created_at": "2025-01-19T10:00:00-05:00",
                    "variants": [
                        {
                            "price": "not-a-number",
                            "option1": "40mm"
                        }
                    ]
                }
            ]
        };

        // Mock source config
        const mockSource = {
            name: 'Test Store',
            url: 'https://test-store.com/products.json?limit=250',
            baseUrl: 'https://test-store.com'
        };

        // Parse function (extracted from app.js)
        function parseShopifyProducts(source, data) {
            const watches = [];
            
            data.products.forEach((product) => {
                try {
                    const name = product.title;
                    
                    if (!name || typeof name !== 'string' || name.trim().length === 0) {
                        return;
                    }
                    
                    const variant = product.variants && product.variants[0];
                    if (!variant || !variant.price) return;
                    
                    const priceValue = parseFloat(variant.price);
                    if (isNaN(priceValue)) {
                        return;
                    }
                    const price = `$${priceValue.toFixed(2)}`;
                    
                    let size = null;
                    
                    if (variant.option1 && variant.option1.match(/\d+\.?\d*\s*mm/i)) {
                        size = variant.option1;
                    } else if (product.tags) {
                        const tags = Array.isArray(product.tags) 
                            ? product.tags 
                            : product.tags.split(',').map(t => t.trim());
                        const sizeTag = tags.find(tag => tag.match(/\d+\.?\d*\s*mm/i));
                        if (sizeTag) {
                            size = sizeTag;
                        }
                    }
                    
                    if (!size && name) {
                        const sizeMatch = name.match(/(\d+\.?\d*\s*mm)/i);
                        if (sizeMatch) {
                            size = sizeMatch[1];
                        }
                    }
                    
                    const timestamp = product.created_at ? new Date(product.created_at).getTime() : Date.now();
                    
                    watches.push({
                        name: name,
                        price: price,
                        size: size || 'N/A',
                        source: source.name,
                        timestamp: timestamp
                    });
                } catch (err) {
                    console.error('Error parsing product:', err, product);
                }
            });
            
            return watches;
        }

        // Test the parser
        const watches = parseShopifyProducts(mockSource, mockShopifyResponse);
        
        // Display results
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<h2>Parsed Watches:</h2><pre>' + 
            JSON.stringify(watches, null, 2) + '</pre>';
        
        console.log('Parsed watches:', watches);
        
        // Validation
        const tests = [
            { name: 'Should parse 3 valid watches (skip 2 invalid)', pass: watches.length === 3 },
            { name: 'First watch should have size from option1', pass: watches[0].size === '40mm' },
            { name: 'Second watch should have size from tags', pass: watches[1].size === '42mm' },
            { name: 'Third watch should extract size from title', pass: watches[2].size === '40mm' },
            { name: 'Prices should be formatted correctly', pass: watches[0].price === '$425.00' },
            { name: 'Should skip products with empty names', pass: !watches.find(w => w.name === '') },
            { name: 'Should skip products with invalid prices', pass: !watches.find(w => w.price.includes('NaN')) },
            { name: 'All watches should use source.name', pass: watches.every(w => w.source === 'Test Store') },
            { name: 'Watches should be sorted by timestamp', pass: watches[0].timestamp < watches[1].timestamp }
        ];
        
        resultsDiv.innerHTML += '<h2>Test Results:</h2>';
        tests.forEach(test => {
            const status = test.pass ? '✅ PASS' : '❌ FAIL';
            resultsDiv.innerHTML += `<p>${status}: ${test.name}</p>`;
            console.log(status, test.name);
        });
        
        const allPassed = tests.every(t => t.pass);
        resultsDiv.innerHTML += `<h2>${allPassed ? '✅ All Tests Passed!' : '❌ Some Tests Failed'}</h2>`;
    </script>
</body>
</html>
